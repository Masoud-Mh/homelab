services:
  traefik:
    image: traefik:v3.6.7
    container_name: traefik
    restart: unless-stopped

    ports:
      # LAN-only HTTP (bind to your LAN IP, not all interfaces)
      - "80:80"

    command:
      - "--configFile=/etc/traefik/traefik.yml"


    labels:
      - "traefik.enable=true"

      # Router: only match when Host is traefik.local AND path is /dashboard or /api
      # - "traefik.http.routers.traefik.rule=(Host(`traefik.local`) || Host(`traefik.masoud-mh.com`)) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))"
      - "traefik.http.routers.traefik.rule=(Host(`traefik.local`) || Host(`traefik.masoud-mh.com`)) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))"
      - "traefik.http.routers.traefik.entrypoints=web"

      # Service: route to Traefik's internal API/dashboard service
      - "traefik.http.routers.traefik.service=api@internal"

      # Middleware: Basic Auth protection
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_USERS:?set TRAEFIK_DASHBOARD_USERS in .env}"
      - "traefik.http.routers.traefik.middlewares=traefik-auth"


    volumes:
      # Read-only access to Docker socket so Traefik can discover containers
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - ./config/traefik.yml:/etc/traefik/traefik.yml:ro

    networks:
      - proxy

networks:
  proxy:
    name: traefik_proxy
